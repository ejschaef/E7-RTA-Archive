{% extends "layouts/base.html" %}

{% block title %}Icon Feather{% endblock title %}

{% block content %}

    <!-- [ Main Content ] start -->
    <div class="pc-container" data-bs-theme="dark">
      <div class="pc-content" data-bs-theme="dark">
        <!-- [ breadcrumb ] start -->

        <!-- [ breadcrumb ] end -->

        <!-- [ Main Content ] start -->
        <div class="row justify-content-center">
          <!-- [ feather-icon ] start -->
          <div class="col-sm-8">
            <div class="card">
              <div class="card-header text-center">
                <h3>Upload User Battles From Local File</h3>
                <h6 class="small-text">CSV Only; files must follow exact structure as battle data files downloaded from this site and only contain battles from one user as Player 1.</h6>
              </div>
              <div class="card-body text-center">
                <div class="row justify-content-center">
                    <form id="uploadForm" class="card-body">
                        {{ form.hidden_tag() }}
                        <h4 class="text-center f-w-500 mt-4 mb-3">Upload CSV</h4>
                        <span id="uploadMSG" class="d-block text-safe mb-3"></span>
                        <span id="uploadError"class="d-block text-danger mb-3"></span>
                        <div class="form-group mb-3">
                          {{ form.file(class="form-control", id="csvFile") }}
                        </div>
                        <div class="d-flex justify-content-center text-center gap-4 mt-4">
                            <button type="submit" name="battle_data" class="btn btn-primary shadow px-sm-4">Submit File</button>
                            <span class="toggle-container">
                                <label class="toggle-switch">
                                  <input type="checkbox" id="auto-query-flag" checked>
                                  <span class="toggle-switch-background">
                                    <span class="toggle-switch-handle"></span>
                                  </span>
                                </label>
                                <h6> Auto-Query New Battles</h6></span>
                        </div>
                    </form>
                </div>
              </div>
            </div>
          </div>
          <!-- [ feather-icon ] end -->
        </div>
        <!-- [ Main Content ] end -->
      </div>
    </div>

{% endblock content %}

{% block extra_js %}

<script type="module">
  import { CSVParse, PYAPI, BattleManager, HeroManager, ClientCache } from "{{ url_for('static', filename='assets/js/exports.js') }}"

  let selectedFile = null;
  // await HeroManager.deleteHeroManager();
  const HM = await HeroManager.getHeroManager();

  // Capture file when selected
  document.getElementById('csvFile').addEventListener('change', function(event) {
      selectedFile = event.target.files[0];
  });

  // Intercept form submission
  document.getElementById('uploadForm').addEventListener('submit', async function(event) {
      console.log("Processing Submission")

      event.preventDefault(); // Prevent actual form submission to server

      if (!selectedFile) {
          alert("Please select a CSV file first.");
          return;
      }

      // Get its state of auto-query checkbox
      const checkbox = document.getElementById("auto-query-flag");
      const autoQueryFlag = checkbox.checked;

      try {
          const battleArr = await CSVParse.parseUpload(selectedFile);

          await ClientCache.clearUserData();

          await BattleManager.cacheUpload(battleArr);

          await PYAPI.serverProcessUpload(battleArr, autoQueryFlag)
          .then(response => response.json())
          .then(async data => {
            console.log(`GOT DATA FROM PYTHON LOOKUP: ${JSON.stringify(data)}`);
            if (data.success) {
              console.log("Server communication successful; recieved response data for file upload")
              document.getElementById("uploadMSG").textContent = "CSV uploaded successfully";
              document.getElementById("csvFile").value = "";
              await BattleManager.cacheQuery(data.battles, HM);
              const filteredBattles = BattleManager.getNumericalFilteredBattles([], HM);
            } else {
              console.log("Server communication unsuccessful")
              document.getElementById("uploadError").textContent = data.error;
            }
          });
          // You can now store the data, process it, or update your app state
      } catch (err) {
        console.error("Caught Error:", err);
        document.getElementById("uploadError").textcontent = err.message;
      }
  });
</script>

{% endblock extra_js %}
