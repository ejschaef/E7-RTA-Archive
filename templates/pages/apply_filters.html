{% extends "layouts/base.html" %}

{% block title %}Icon Feather{% endblock title %}

{% block content %}

    <!-- [ Main Content ] start -->
    <div class="pc-container" data-bs-theme="dark">
      <div class="pc-content" data-bs-theme="dark">
        <!-- [ breadcrumb ] start -->

        <!-- [ breadcrumb ] end -->

        <!-- [ Main Content ] start -->
        <div class="row justify-content-center">
          <!-- [ feather-icon ] start -->
          <div class="col-sm-12">
            <div class="card">
              <div class="card-header text-center tight-fit">
                <h3>Apply filter to battle data.</h3>
                <h6 class="small-text">Syntax rules and examples can be viewed in the 'Syntax Rules' section. Use the 'Check Syntax' button to verify the filter is properly formed.</h6>
              </div>
              <div class="card-body text-center tight-fit">
                <div class="row justify-content-center">
                    {% if error %}
                            <span class="d-block text-danger mb-3">{{ error | safe }}</span>
                    {% elif validation_msg %}
                            <span class="d-block text-safe mb-3">{{ validation_msg| safe }}</span>
                    {% endif %}
                    <form method="post" class="card-body">
                        {{ form.hidden_tag() }}
                        <textarea id="codeArea" name="code" class="codemirror-hidden">{{ code or '' }}</textarea>
                        <div class="d-flex justify-content-center gap-3 mt-4">
                            <button type="submit" name="check-syntax" class="btn btn-primary shadow px-sm-4">Check Syntax</button>
                            <button type="submit" name="apply-filter" class="btn btn-primary shadow px-sm-4">Apply Filter</button>
                        </div>
                    </form>
                </div>
              </div>
            </div>
          </div>
          <!-- [ feather-icon ] end -->
        </div>
        <!-- [ Main Content ] end -->
      </div>
    </div>

{% endblock content %}

{% block extra_js %}

<script>
    CodeMirror.defineMode("myMode", function() {
      return {
        token: function(stream) {
            if (stream.match(/int\(\d+\)/i)) {
                return "number"; // match a number
            }
            if (stream.match(/date\(\d\d\d\d-\d\d-\d\d\)/i)) {
                return "date"; // match a number
            }
            if (stream.match(/str\([A-Za-z ]+\)/i)) {
                return "string"; // match a number
            }
            if (stream.match(/set\([A-Za-z ,]+\)/i)) {
                return "set"; // match a number
            }
            if (stream.match(/AND(?=\()|OR(?=\()|XOR(?=\()|STR(?=\()|INT(?=\()|DATE(?=\()|SET(?=\()/i)) {
             return "keyword";
            }
            if (stream.match(/\s+(?:<>|<|>|=|>=|<=|in|<>in)(?=\s+)/i)) {
                return "operator"; // match a number
            }
            if (stream.match(/(?:^|\s+)(?:true|false)(?:(?=\,)|(?=\))|(?=\s+)|$|(?=\;))/i)) {
                return "bool"; // match a field
            }
            if (stream.match(/(?:^|\s+)(?:battle-date|firstpick|win|victory-points|p1.picks|p2.picks|p1.pick1|p1.pick2|p1.pick3|p1.pick4|p1.pick5|p2.pick1|p2.pick2|p2.pick3|p2.pick4|p2.pick5|p1.league|p2.league)(?:(?=\,)|(?=\))|(?=\s+)|$|(?=\;))/i)) {
                return "field"; // match a field
            }
            if (stream.match(/[\(\)\{\}\;\,]/)) {
                return "bracket"; // match a quoted string
            }
            stream.next();
            return null;
        }
      };
    });

    const textarea = document.getElementById("codeArea");
    const editor = CodeMirror.fromTextArea(textarea, {
      mode: "myMode",
      lineNumbers: true,
      theme: "default"
    });

    // Ensure value is synced back to textarea before submit
    document.querySelector("form").addEventListener("submit", function() {
      document.getElementById("codeArea").value = editor.getValue();
    });

        // Optional: sync changes back to textarea if needed
    editor.on("change", () => {
        editor.save(); // Updates the hidden textarea for form submit
    });

    // Show the editor after it's initialized
    textarea.classList.remove('codemirror-hidden');
</script>

{% endblock extra_js %}
